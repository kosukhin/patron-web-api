<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .menu ul {
            padding: 0;
            display: flex;
            list-style-type: none;
            gap: 12px;
        }

        .page-content {
            max-width: 600px;
        }
    </style>
</head>

<body>
<h1>Route</h1>
<div class="menu">
    <ul>
        <li>
            <button onclick="route.page('/')">
                Главная
            </button>
        </li>
        <li>
            <button onclick="route.page('/two')">
                Вторая
            </button>
        </li>
        <li>
            <button onclick="route.page('/three')">
                Третья
            </button>
        </li>
    </ul>
</div>
<div class="page-content"></div>
<script type="module">
  import 'https://cdn.jsdelivr.net/npm/patron-oop@1.10.0/dist/patron.min.js';
  import {HistoryCurrentPage, HistoryNewPage} from 'http://localhost:63342/patron-web-api/dist/patron-web-api.mjs';

  const {
    give,
    Patron,
    Source,
    GuestChain,
  } = window.GUEST_LIBRARY;

  class PageOne {
    mounted() {
      console.log('show page one');
      document.title = 'Главная страница';
    }
  }

  class PageTwo {
    mounted() {
      console.log('show page two');
      document.title = 'Вторая страница';
    }
  }

  class PageThree {
    mounted() {
      console.log('show page three');
      document.title = 'Третья страница';
    }
  }

  class Route {
    #currentPage;
    #newPage;
    #basePath;

    constructor(basePath, currentPage, newPage) {
      this.#currentPage = currentPage;
      this.#newPage = newPage;
      this.#basePath = basePath;
    }

    page(url) {
      this.#basePath.receiving(
          (basePath) => {
            this.#newPage.receive({
              url: `${basePath}${url}`,
              title: 'Идет загрузка',
              data: {
                url: `${basePath}${url}`,
                date: new Date().getTime(),
              },
            });
          },
      );
    }

    handleRoutes(
        displaySelector,
        routes,
    ) {
      const contentEl = document.querySelector(displaySelector);
      this.firstLoad(
          () => {
            this.#currentPage.page(new Patron((value) => {
              this.#basePath.receiving(
                  (basePath) => {
                    basePath = basePath.replace('/#', '');
                    let currentUrl = value.url === '/' ? basePath + '/' : value.url;
                    currentUrl = currentUrl.replace('#', '').replace('//', '/');
                    const route = routes.find(route => basePath + route.url === currentUrl);

                    if (route) {
                      fetch(basePath + '/' + route.template).then(result => result.text()).then(template => {
                        contentEl.innerHTML = template;
                        route.page?.mounted();
                      });
                    }
                  },
              );
            }));
          },
      );
    }

    firstLoad(guest) {
      const chain = new GuestChain();
      this.#basePath.receiving(chain.receiveKey('basePath'));
      this.#currentPage.page(chain.receiveKey('currentPage'));
      chain.result(
          ({basePath, currentPage}) => {
            const correctUrl = location.href.replace(location.origin, '');

            if (currentPage.url !== correctUrl) {
              this.page(correctUrl.replace(basePath, ''));
              setTimeout(() => {
                give(null, guest);
              });
            }
          },
      );
    }
  }

  const pageSource = new Source({
    title: 'Главная',
    url: '/',
  });
  window.route = new Route(
      new Source('/patron-web-api/examples/history-api/router/#'),
      new HistoryCurrentPage(pageSource),
      new HistoryNewPage(pageSource),
  );
  route.handleRoutes(
      '.page-content',
      [
        {
          url: '/',
          template: 'main.html',
          page: new PageOne(),
        },
        {
          url: '/index.html',
          template: 'main.html',
          page: new PageOne(),
        },
        {
          url: '/two',
          template: 'two.html',
          page: new PageTwo(),
        },
        {
          url: '/three',
          template: 'three.html',
          page: new PageThree(),
        },
      ],
  );
</script>
</body>

</html>
